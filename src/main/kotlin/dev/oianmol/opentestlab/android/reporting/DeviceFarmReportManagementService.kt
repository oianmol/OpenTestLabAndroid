package dev.oianmol.dev.oianmol.opentestlab.android.reporting

import dev.oianmol.opentestlab.android.testexec.TestExecScope
import dev.oianmol.opentestlab.api.models.ReportFiles
import dev.oianmol.opentestlab.api.models.ReportsRequest
import kotlinx.coroutines.CoroutineDispatcher
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.flow.flow
import kotlinx.coroutines.flow.flowOn

class DeviceFarmReportManagementService(
    private val testExecScope: TestExecScope,
    dispatcher: CoroutineDispatcher = Dispatchers.IO
) {
    fun pullReportFiles(request: ReportsRequest) = flow<ReportFiles> {
        for (it in testExecScope.workingReportsDir(request).listFiles() ?: emptyArray()) {
            val stream = it.inputStream()
            var size = it.length()
            while (size != 0L) {
                val read = ByteArray(Math.min(size, 4086L).toInt())
                val readBytes = stream.read(read)
                size -= readBytes
                emit(
                    ReportFiles(fileName = it.name, reportFile = read)
                )

            }
            stream.close()
        }
    }
        .flowOn(Dispatchers.IO)
}