package dev.oianmol.opentestlab.android.testexec

import com.vendsy.testlab.DeviceFarmTestSpec
import com.vendsy.testlab.FileType
import com.vendsy.testlab.ReportsRequest
import com.vendsy.testlab.TestApkUpload
import io.grpc.Status
import io.grpc.StatusException
import java.io.File
import java.nio.file.Files
import kotlin.io.path.absolutePathString

object DeviceFarmTestExecScope : TestExecScope {

    override suspend fun writeFiles(it: TestApkUpload, function: suspend () -> Unit) {
        testWorkingDir(it.ciUniqueBuildNumber).apply {
            when (it.fileType) {
                FileType.TestApk -> androidTestApk(this).appendBytes(it.testApk.toByteArray()).also { function() }
                FileType.AndroidApk -> androidAppApk(this).appendBytes(it.testApk.toByteArray()).also { function() }
                else -> throw StatusException(Status.INVALID_ARGUMENT)
            }
        }
    }

    override fun createDirs(ciUniqueBuildNumber: String) {
        testWorkingDir(ciUniqueBuildNumber).apply {
            mkdirs()
            // we delete these files if existing already!
            androidTestApk(this).delete()
            androidAppApk(this).delete()
        }
    }

    override fun workingReportsDir(request: ReportsRequest): File {
        val workingdir = testWorkingDir(request.ciUniqueBuildNumber)
        return File(workingdir, "reports")
    }

    override fun prepareFor(request: DeviceFarmTestSpec): TestExecutionTaskSpec {
        return with(testWorkingDir(request.ciUniqueBuildNumber)) {
            TestExecutionTaskSpec(
                workingDir = this,
                androidTestApk = androidTestApk(this),
                androidAppApk = androidAppApk(this),
                listenerClass = request.listenerClass,
                testPackageFilter = request.testPackageFilter,
                instrumentPackage = request.instrumentPackage,
                customRunner = request.customRunner,
                packageName = request.packageName,
                testPackageName = request.testPackageName,
            )
        }
    }

    private fun testWorkingDir(ciUniqueBuildNumber: String) = File(
        userHome().plus(File.separator) + "deviceFarm",
        ciUniqueBuildNumber
    )

    private fun userHome(): String =
        System.getProperty("user.home") ?: Files.createTempDirectory("test").absolutePathString()

    private fun apksDir(testResultsDir: File) = File(testResultsDir, "apks").apply { mkdirs() }
    private fun androidAppApk(testResultsDir: File) = File(apksDir(testResultsDir), "android.apk")
    private fun androidTestApk(testResultsDir: File) = File(apksDir(testResultsDir), "androidTest.apk")

}