package dev.oianmol.opentestlab.tasks

import dev.oianmol.opentestlab.ReportManagementServiceGrpcKt
import kotlinx.coroutines.runBlocking
import org.gradle.api.DefaultTask
import org.gradle.api.tasks.TaskAction
import java.util.concurrent.TimeUnit.SECONDS

abstract class TestLabPullReportTask : DefaultTask() {
    @TaskAction
    fun pullTestReports() {
        val channel = project.managedChannel()
        runBlocking {
            runCatching {
                with(ReportManagementServiceGrpcKt.ReportManagementServiceCoroutineStub(channel)) {
                    val build = buildIdentifier(project)
                    project.logger.info("Build $build")
                    val directory = fileForTestResults(project)
                    project.logger.info("fileForTestResults ${directory.absolutePath}")
                    pullReportsFromDeviceFarm(this, build, directory, project)
                }
            }
        }
        channel.shutdown().awaitTermination(5L, SECONDS)
    }
}