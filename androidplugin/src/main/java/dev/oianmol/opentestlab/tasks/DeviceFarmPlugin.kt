package dev.oianmol.opentestlab.tasks


import org.gradle.api.Plugin
import org.gradle.api.Project

class DeviceFarmPlugin : Plugin<Project> {
    companion object {
        const val GRADLE_METHOD_NAME = "configureOpenDeviceFarm"
    }

    override fun apply(project: Project) {
        with(project) {
            project.extensions.create(
                GRADLE_METHOD_NAME,
                DeviceFarmPluginExtension::class.java,
                project
            )

            project.afterEvaluate {
                logger.lifecycle("*************** Open Test Lab Plugin ***************")
                deviceFarm()
                logger.lifecycle("********************************************************")
            }
        }
    }
}

fun Project.deviceFarm() {
    project.extensions.findByType(DeviceFarmPluginExtension::class.java)?.apply {
        this.applicationId?.let {
            tasks.register(
                "executeDeviceFarmFor${it.replace(".", "dot")}",
                AndroidTestDeviceFarmTask::class.java,
            )

            tasks.register(
                "pullLatestTestReportFor${it.replace(".", "dot")}",
                TestLabPullReportTask::class.java,
            )
        }
    }
}
